<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.4/purify.min.js"
      integrity="sha512-jGh38w63cHRzfBHtyKgEMMkJswUFXDA3YXrDjaE8ptzxV5DDkLDUDjtGUy5tmDkOXHWsItKfFjocaEtj1WuVnQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"
      referrerpolicy="no-referrer"
    ></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/atom-one-dark.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <title>Workbin</title>
  </head>
  <body>
    <div class="nav">
      <span>Workbin</span>
      <div class="fill"></div>
      <select name="language" id="language" onchange="setLanguage()">
        <option value="python">Python</option>
        <option value="abap">Abap</option>
        <option value="abc">Abc</option>
        <option value="actionscript">Actionscript</option>
        <option value="ada">Ada</option>
        <option value="alda">Alda</option>
        <option value="apache_conf">Apache_Conf</option>
        <option value="apex">Apex</option>
        <option value="applescript">Applescript</option>
        <option value="aql">Aql</option>
        <option value="asciidoc">Asciidoc</option>
        <option value="asl">Asl</option>
        <option value="assembly_x86">Assembly_X86</option>
        <option value="autohotkey">Autohotkey</option>
        <option value="batchfile">Batchfile</option>
        <option value="c9search">C9Search</option>
        <option value="c_cpp">C_Cpp</option>
        <option value="cirru">Cirru</option>
        <option value="clojure">Clojure</option>
        <option value="cobol">Cobol</option>
        <option value="coffee">Coffee</option>
        <option value="coldfusion">Coldfusion</option>
        <option value="crystal">Crystal</option>
        <option value="csharp">Csharp</option>
        <option value="csound_document">Csound_Document</option>
        <option value="csound_orchestra">Csound_Orchestra</option>
        <option value="csound_score">Csound_Score</option>
        <option value="csp">Csp</option>
        <option value="css">Css</option>
        <option value="curly">Curly</option>
        <option value="dart">Dart</option>
        <option value="diff">Diff</option>
        <option value="django">Django</option>
        <option value="d">D</option>
        <option value="dockerfile">Dockerfile</option>
        <option value="dot">Dot</option>
        <option value="drools">Drools</option>
        <option value="edifact">Edifact</option>
        <option value="eiffel">Eiffel</option>
        <option value="ejs">Ejs</option>
        <option value="elixir">Elixir</option>
        <option value="elm">Elm</option>
        <option value="erlang">Erlang</option>
        <option value="forth">Forth</option>
        <option value="fortran">Fortran</option>
        <option value="fsharp">Fsharp</option>
        <option value="fsl">Fsl</option>
        <option value="ftl">Ftl</option>
        <option value="gcode">Gcode</option>
        <option value="gherkin">Gherkin</option>
        <option value="gitignore">Gitignore</option>
        <option value="glsl">Glsl</option>
        <option value="gobstones">Gobstones</option>
        <option value="golang">Golang</option>
        <option value="graphqlschema">Graphqlschema</option>
        <option value="groovy">Groovy</option>
        <option value="haml">Haml</option>
        <option value="handlebars">Handlebars</option>
        <option value="haskell_cabal">Haskell_Cabal</option>
        <option value="haskell">Haskell</option>
        <option value="haxe">Haxe</option>
        <option value="hjson">Hjson</option>
        <option value="html_elixir">Html_Elixir</option>
        <option value="html">Html</option>
        <option value="html_ruby">Html_Ruby</option>
        <option value="ini">Ini</option>
        <option value="io">Io</option>
        <option value="jack">Jack</option>
        <option value="jade">Jade</option>
        <option value="java">Java</option>
        <option value="javascript">Javascript</option>
        <option value="json5">Json5</option>
        <option value="jsoniq">Jsoniq</option>
        <option value="json">Json</option>
        <option value="jsp">Jsp</option>
        <option value="jssm">Jssm</option>
        <option value="jsx">Jsx</option>
        <option value="julia">Julia</option>
        <option value="kotlin">Kotlin</option>
        <option value="latex">Latex</option>
        <option value="latte">Latte</option>
        <option value="less">Less</option>
        <option value="liquid">Liquid</option>
        <option value="lisp">Lisp</option>
        <option value="livescript">Livescript</option>
        <option value="logiql">Logiql</option>
        <option value="logtalk">Logtalk</option>
        <option value="lsl">Lsl</option>
        <option value="lua">Lua</option>
        <option value="luapage">Luapage</option>
        <option value="lucene">Lucene</option>
        <option value="makefile">Makefile</option>
        <option value="markdown">Markdown</option>
        <option value="mask">Mask</option>
        <option value="matlab">Matlab</option>
        <option value="maze">Maze</option>
        <option value="mediawiki">Mediawiki</option>
        <option value="mel">Mel</option>
        <option value="mips">Mips</option>
        <option value="mixal">Mixal</option>
        <option value="mushcode">Mushcode</option>
        <option value="mysql">Mysql</option>
        <option value="nginx">Nginx</option>
        <option value="nim">Nim</option>
        <option value="nix">Nix</option>
        <option value="nsis">Nsis</option>
        <option value="nunjucks">Nunjucks</option>
        <option value="objectivec">Objectivec</option>
        <option value="ocaml">Ocaml</option>
        <option value="pascal">Pascal</option>
        <option value="perl">Perl</option>
        <option value="pgsql">Pgsql</option>
        <option value="php">Php</option>
        <option value="php_laravel_blade">Php_Laravel_Blade</option>
        <option value="pig">Pig</option>
        <option value="plain_text">Plain_Text</option>
        <option value="powershell">Powershell</option>
        <option value="praat">Praat</option>
        <option value="prisma">Prisma</option>
        <option value="prolog">Prolog</option>
        <option value="properties">Properties</option>
        <option value="protobuf">Protobuf</option>
        <option value="puppet">Puppet</option>
        <option value="qml">Qml</option>
        <option value="raku">Raku</option>
        <option value="razor">Razor</option>
        <option value="rdoc">Rdoc</option>
        <option value="red">Red</option>
        <option value="redshift">Redshift</option>
        <option value="rhtml">Rhtml</option>
        <option value="r">R</option>
        <option value="rst">Rst</option>
        <option value="ruby">Ruby</option>
        <option value="rust">Rust</option>
        <option value="sass">Sass</option>
        <option value="scad">Scad</option>
        <option value="scala">Scala</option>
        <option value="scheme">Scheme</option>
        <option value="scrypt">Scrypt</option>
        <option value="scss">Scss</option>
        <option value="sh">Sh</option>
        <option value="sjs">Sjs</option>
        <option value="slim">Slim</option>
        <option value="smarty">Smarty</option>
        <option value="smithy">Smithy</option>
        <option value="snippets">Snippets</option>
        <option value="soy_template">Soy_Template</option>
        <option value="space">Space</option>
        <option value="sparql">Sparql</option>
        <option value="sql">Sql</option>
        <option value="sqlserver">Sqlserver</option>
        <option value="stylus">Stylus</option>
        <option value="svg">Svg</option>
        <option value="swift">Swift</option>
        <option value="tcl">Tcl</option>
        <option value="terraform">Terraform</option>
        <option value="tex">Tex</option>
        <option value="textile">Textile</option>
        <option value="text">Text</option>
        <option value="toml">Toml</option>
        <option value="tsx">Tsx</option>
        <option value="turtle">Turtle</option>
        <option value="twig">Twig</option>
        <option value="typescript">Typescript</option>
        <option value="vala">Vala</option>
        <option value="vbscript">Vbscript</option>
        <option value="velocity">Velocity</option>
        <option value="verilog">Verilog</option>
        <option value="vhdl">Vhdl</option>
        <option value="visualforce">Visualforce</option>
        <option value="wollok">Wollok</option>
        <option value="xml">Xml</option>
        <option value="xquery">Xquery</option>
        <option value="yaml">Yaml</option>
        <option value="zeek">Zeek</option>
      </select>
      <div class="sep"></div>
      <button onclick="window.location.href = '/'">New</button>
      <div class="sep"></div>
      <button id="savebutton" onclick="save()">Save</button>
    </div>
    <div class="editors" id="editors">
      <div id="editor" class="primaryEditor"></div>
      <div id="viewEditor" class="viewEditor nv"></div>
    </div>

    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
      window.canSave = true;

      function createEditor(elemId) {
        var editor = ace.edit(elemId);
        editor.setTheme("ace/theme/one_dark");
        editor.session.setMode("ace/mode/python");
        editor.setShowPrintMargin(false);
        return editor;
      }

      const primaryEditor = createEditor("editor");
      const viewEditor = createEditor("viewEditor");

      function setDualDisplay() {
        const primary = document.getElementById("editor");
        const view = document.getElementById("viewEditor");

        primary.classList.add("hw");
        view.classList.remove("nv");
      }

      function setEditorValue(editor, value, readonly) {
        editor.session.setValue(value);
        editor.setReadOnly(readonly);
      }

      function setupPage() {
        const url = new URL(window.location.href);
        const id = url.searchParams.get("id");
        const language = url.searchParams.get("language");
        const compare = url.searchParams.get("compare");
        const mdViewer = url.searchParams.get("md");

        if (language) {
          document.getElementById("language").value = language;
          setLanguage();
        }

        if (id) {
          window.canSave = false;
          fetch(`/api/item?key=${id}`)
            .then(res => res.text())
            .then(data => {
              if (!mdViewer) {
                setEditorValue(primaryEditor, data, true);
                document.getElementById("savebutton").style.display = "none";
              } else {
                const md = marked.parse(data);
                const el = document.getElementById("editors");
                el.classList.add("mdv");
                el.innerHTML = DOMPurify.sanitize(md);
                hljs.highlightAll();
              }
            });
        }

        if (compare && !mdViewer) {
          fetch(`/api/item?key=${compare}`)
            .then(res => res.text())
            .then(data => {
              setEditorValue(viewEditor, data, true);
              setDualDisplay();
            });
        }
      }

      setupPage();

      document.addEventListener(
        "keydown",
        function (e) {
          if ((window.navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey) && e.keyCode == 83) {
            e.preventDefault();
            save();
          }
        },
        false,
      );

      function setLanguage() {
        const elem = document.getElementById("language");
        primaryEditor.session.setMode("ace/mode/" + elem.value);
      }

      function save() {
        if (!window.canSave) {
          return;
        }

        const val = primaryEditor.getValue();

        fetch("/api/new", {
          method: "POST",
          body: val,
        }).then(res =>
          res.json().then(data => {
            const key = data.key;
            window.location.href = `/?id=${key}&language=${document.getElementById("language").value}`;
          }),
        );
      }
    </script>
  </body>

  <style type="text/css" media="screen">
    body,
    html {
      margin: 0;
      background-color: #282c34;
    }

    .nav {
      height: 2rem;
      background: #161616;
      margin: none;
      color: #f6f6f6;
      font-family: "Open Sans", sans-serif;
      display: flex;
      align-items: center;
      flex-direction: row;

      padding-left: 1rem;
      padding-right: 1rem;

      border-bottom: 0.25rem solid #575e6b;
    }

    .nav .fill {
      width: 100%;
    }

    .nav button,
    .nav select {
      background: #5c5c5c;
      border-style: none;
      border-radius: 0.25rem;
      color: #f6f6f6;
    }

    .nav .sep {
      width: 0.5rem;
    }

    .primaryEditor {
      position: absolute;
      top: 2.25rem;
      right: 0;
      bottom: 0;
      left: 0;
    }

    .hw {
      width: 50%;
    }

    .viewEditor {
      position: absolute;
      top: 2.25rem;
      right: 50%;
      bottom: 0;
      left: 50%;
      width: calc(50% - 0.25rem);
      border-left: 0.25rem solid #575e6b;
    }

    .nv {
      display: none;
    }

    .mdv {
      padding-left: 20%;
      padding-right: 20%;
      color: #f6f6f6;
      font-family: "Open Sans", sans-serif;
    }

    @media only screen and (max-width: 768px) {
      .mdv {
        padding-left: 0;
        padding-right: 0;
      }
    }

    .mdv a {
      text-decoration: none;
    }

    .mdv code {
      border-radius: 0.75rem;
      border: 1px solid #e2e2e2;
    }
  </style>
</html>
